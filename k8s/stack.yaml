apiVersion: v1
kind: Namespace
metadata:
  name: microservices
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: init-sql
  namespace: microservices
data:
  init.sql: |
    -- Create databases idempotently (PostgreSQL)
    SELECT 'CREATE DATABASE order_db'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'order_db')\gexec
    SELECT 'CREATE DATABASE payment_db'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'payment_db')\gexec
    SELECT 'CREATE DATABASE shipping_db'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'shipping_db')\gexec

    -- Use order database
    \connect order_db

    -- Create tables for order database
    CREATE TABLE IF NOT EXISTS orders (
        id SERIAL PRIMARY KEY,
        customer_id INT NOT NULL,
        total_price DECIMAL(10, 2) NOT NULL DEFAULT 0,
        status VARCHAR(50) DEFAULT 'Pending',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS order_items (
        id SERIAL PRIMARY KEY,
        order_id INT NOT NULL REFERENCES orders(id),
        product_code VARCHAR(100) NOT NULL,
        unit_price DECIMAL(10, 2) NOT NULL,
        quantity INT NOT NULL
    );

    -- Table to store inventory items
    CREATE TABLE IF NOT EXISTS products (
        id SERIAL PRIMARY KEY,
        product_code VARCHAR(100) UNIQUE NOT NULL,
        name VARCHAR(255) NOT NULL,
        price DECIMAL(10, 2) NOT NULL,
        quantity INT NOT NULL DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        deleted_at TIMESTAMP NULL
    );

    -- Insert sample products (you can add more as needed)
    INSERT INTO products (product_code, name, price, quantity) VALUES
    ('PROD001', 'Product 1', 99.99, 100),
    ('PROD002', 'Product 2', 149.99, 50),
    ('PROD003', 'Product 3', 199.99, 75),
    ('PROD004', 'Product 4', 49.99, 200),
    ('PROD005', 'Product 5', 299.99, 30)
    ON CONFLICT (product_code) DO NOTHING;

    -- Use payment database
    \connect payment_db

    -- Create tables for payment database
    CREATE TABLE IF NOT EXISTS payments (
        id SERIAL PRIMARY KEY,
        order_id INT NOT NULL,
        user_id INT NOT NULL,
        total_price DECIMAL(10, 2) NOT NULL,
        status VARCHAR(50) DEFAULT 'Pending',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS bills (
        id SERIAL PRIMARY KEY,
        payment_id INT NOT NULL REFERENCES payments(id),
        bill_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Use shipping database
    \connect shipping_db

    -- Create tables for shipping database
    CREATE TABLE IF NOT EXISTS shipping (
        id SERIAL PRIMARY KEY,
        order_id INT NOT NULL,
        delivery_days INT NOT NULL,
        status VARCHAR(50) DEFAULT 'Pending',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: microservices
type: Opaque
stringData:
  POSTGRES_USER: user
  POSTGRES_PASSWORD: password
  POSTGRES_DB: microservices
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: microservices
spec:
  ports:
    - port: 5432
      targetPort: 5432
  selector:
    app: postgres
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: microservices
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_DB
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
            - name: init-sql
              mountPath: /docker-entrypoint-initdb.d/init.sql
              subPath: init.sql
          readinessProbe:
            tcpSocket:
              port: 5432
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: init-sql
          configMap:
            name: init-sql
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: microservices-config
  namespace: microservices
data:
  ENV: development
  ORDER_APPLICATION_PORT: "50051"
  PAYMENT_APPLICATION_PORT: "50052"
  SHIPPING_APPLICATION_PORT: "50053"
  ORDER_DATABASE_URL: postgres://user:password@postgres:5432/order_db?sslmode=disable
  PAYMENT_DATABASE_URL: postgres://user:password@postgres:5432/payment_db?sslmode=disable
  SHIPPING_DATABASE_URL: postgres://user:password@postgres:5432/shipping_db?sslmode=disable
  PAYMENT_SERVICE_URL: payment:50052
  SHIPPING_SERVICE_URL: shipping:50053
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment
  namespace: microservices
spec:
  replicas: 1
  selector:
    matchLabels:
      app: payment
  template:
    metadata:
      labels:
        app: payment
    spec:
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ["sh", "-c", "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      containers:
        - name: payment
          image: microservices/payment:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: DATABASE_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: PAYMENT_DATABASE_URL
            - name: APPLICATION_PORT
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: PAYMENT_APPLICATION_PORT
            - name: ENV
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: ENV
          ports:
            - containerPort: 50052
          readinessProbe:
            tcpSocket:
              port: 50052
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 50052
            initialDelaySeconds: 10
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: payment
  namespace: microservices
spec:
  selector:
    app: payment
  ports:
    - port: 50052
      targetPort: 50052
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shipping
  namespace: microservices
spec:
  replicas: 1
  selector:
    matchLabels:
      app: shipping
  template:
    metadata:
      labels:
        app: shipping
    spec:
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ["sh", "-c", "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done"]
      containers:
        - name: shipping
          image: microservices/shipping:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: DATABASE_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: SHIPPING_DATABASE_URL
            - name: APPLICATION_PORT
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: SHIPPING_APPLICATION_PORT
          ports:
            - containerPort: 50053
          readinessProbe:
            tcpSocket:
              port: 50053
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 50053
            initialDelaySeconds: 10
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: shipping
  namespace: microservices
spec:
  selector:
    app: shipping
  ports:
    - port: 50053
      targetPort: 50053
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order
  namespace: microservices
spec:
  replicas: 1
  selector:
    matchLabels:
      app: order
  template:
    metadata:
      labels:
        app: order
    spec:
      initContainers:
        - name: wait-for-deps
          image: busybox:1.36
          command: ["sh", "-c", "until nc -z postgres 5432 && nc -z payment 50052 && nc -z shipping 50053; do echo waiting for deps; sleep 2; done"]
      containers:
        - name: order
          image: microservices/order:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: DATABASE_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: ORDER_DATABASE_URL
            - name: APPLICATION_PORT
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: ORDER_APPLICATION_PORT
            - name: PAYMENT_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: PAYMENT_SERVICE_URL
            - name: SHIPPING_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: SHIPPING_SERVICE_URL
            - name: ENV
              valueFrom:
                configMapKeyRef:
                  name: microservices-config
                  key: ENV
          ports:
            - containerPort: 50051
          readinessProbe:
            tcpSocket:
              port: 50051
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 50051
            initialDelaySeconds: 10
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: order
  namespace: microservices
spec:
  selector:
    app: order
  ports:
    - port: 50051
      targetPort: 50051
